<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Secure Docs - Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 text-gray-800 min-h-screen flex items-center justify-center px-2">
  <div class="w-full max-w-xs sm:max-w-xl bg-white p-4 sm:p-6 shadow-lg rounded-lg mt-8 sm:mt-10">
    <h2 class="text-xl sm:text-2xl font-bold mb-4 text-center">Welcome<span id="userName" class="2xl font-bold"></span></h2>

    <div class="flex flex-col sm:flex-row sm:justify-between gap-2 sm:gap-0 mb-4">
      <a href="profile.html" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700 text-center">My Profile</a>
      <button onclick="logout()" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 text-center">Logout</button>
    </div>

    <label for="doc" class="block font-semibold">Upload Document:</label>
    <input type="file" id="doc" class="w-full mb-2">
    <button onclick="uploadDoc()" class="w-full bg-purple-600 text-white font-semibold py-2 rounded hover:bg-purple-700 mb-2">Upload</button>

    <div id="docList" class="mt-4"></div>
  </div>

<script>
const serverURL = "https://secure-docs-backend.onrender.com";



async function fetchUserName() {
  const aadhaar = localStorage.getItem("aadhaar");
  if (!aadhaar) return window.location.href = "login.html";

  const res = await fetch(`${serverURL}/api/auth/profile/${aadhaar}`);
  const data = await res.json();

  if (res.ok && data.profile && data.profile.name) {
    document.getElementById("userName").textContent = `- ${data.profile.name}`;
  }
}


async function uploadDoc() {
  const aadhaar = localStorage.getItem("aadhaar");
  const file = document.getElementById("doc").files[0];
  if (!file) return alert("Select a file");

  const formData = new FormData();
  formData.append("file", file);
  formData.append("ownerAadhaar", aadhaar);

  const res = await fetch(`${serverURL}/api/docs/upload`, {
    method: "POST",
    body: formData
  });

  const data = await res.json();
  alert(data.message);
  fetchDocs();
}

async function fetchDocs() {
  const aadhaar = localStorage.getItem("aadhaar");
  const res = await fetch(`${serverURL}/api/docs/${aadhaar}`);
  const data = await res.json();

  const list = document.getElementById("docList");
  list.innerHTML = '<h3 class="text-lg font-semibold mb-2">üìÑ Your Documents</h3>';

  if (!data.documents || data.documents.length === 0) {
    list.innerHTML += "<p>No documents found.</p>";
    return;
  }

  data.documents.forEach(doc => {
    const fileURL = `${serverURL}/${doc.filePath.replace(/\\/g, "/")}`;
    const item = document.createElement("div");
    item.className = "border-b border-gray-200 py-2";

    item.innerHTML = `
      <strong>${doc.originalName}</strong><br>
      <a href="${fileURL}" target="_blank" class="text-blue-600 underline">üìÑ View</a><br>
      <input type="file" id="updateFile-${doc._id}" class="mt-2">
      <button onclick="updateDoc('${doc._id}')" class="bg-yellow-500 text-white px-3 py-1 rounded mt-1 hover:bg-yellow-600">‚úè Update</button>
      <input type="text" id="shareWith-${doc._id}" placeholder="Enter Aadhaar to share" class="border px-2 py-1 mt-1 rounded w-full">
      <button onclick="shareDoc('${doc._id}')" class="bg-green-500 text-white px-3 py-1 rounded mt-1 hover:bg-green-600">üîó Share</button>
      <button onclick="deleteDoc('${doc._id}')" class="bg-red-500 text-white px-3 py-1 rounded mt-1 hover:bg-red-600">üóëÔ∏è Delete</button>
    `;
    list.appendChild(item);
  });
}

async function updateDoc(id) {
  const file = document.getElementById(`updateFile-${id}`).files[0];
  if (!file) return alert("Select a file to update");

  const formData = new FormData();
  formData.append("file", file);

  const res = await fetch(`${serverURL}/api/docs/update/${id}`, {
    method: "PUT",
    body: formData
  });

  const data = await res.json();
  alert(data.message);
  fetchDocs();
}

async function shareDoc(id) {
  const targetAadhaar = document.getElementById(`shareWith-${id}`).value;
  if (!targetAadhaar) return alert("Enter Aadhaar to share with");

  const res = await fetch(`${serverURL}/api/docs/share/${id}`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ targetAadhaar })
  });

  const data = await res.json();
  alert(data.message);
}

async function deleteDoc(id) {
  if (!confirm("Are you sure?")) return;

  const res = await fetch(`${serverURL}/api/docs/delete/${id}`, {
    method: "DELETE"
  });
  const data = await res.json();
  alert(data.message);
  fetchDocs();
}

function logout() {
  localStorage.removeItem("aadhaar");
  window.location.href = "login.html";
}

window.onload = () => {
  fetchUserName();
  fetchDocs();
};

</script>
</body>
</html>
